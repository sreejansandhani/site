<!doctype html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin â€” Sreejan Sandhani</title>
  <link href="assets/styles.css" rel="stylesheet" />
  <link href="assets/animations.css" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body class="min-h-screen bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 animate-fadeIn">
  <nav class="sticky top-0 z-40 bg-white/90 dark:bg-gray-900/90 backdrop-blur">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="index.html" class="text-lg font-bold text-brand">Sreejan Sandhani</a>
      <div class="flex items-center gap-3">
        <div id="userInfo" class="text-sm"></div>
        <button id="signBtn" class="text-sm px-3 py-2 rounded bg-accent text-white hover:bg-accent/80 transition-all">Sign in</button>
        <button id="signOutBtn" class="hidden text-sm px-3 py-2 rounded border hover:bg-gray-100 dark:hover:bg-gray-800 transition-all">Sign out</button>
      </div>
    </div>
  </nav>

  <main class="max-w-5xl mx-auto px-4 py-8 space-y-8">
    <section class="card rounded-lg bg-white dark:bg-gray-800 p-4 shadow" data-role="Founder">
      <h2 class="text-xl font-semibold mb-3">Event fee management</h2>
      <p class="text-sm text-gray-600 dark:text-gray-300">Simulate fee updates locally (does not write to Sheets).</p>
      <div class="grid sm:grid-cols-3 gap-3 mt-3" id="eventFeeEditor"></div>
      <div class="mt-3">
        <button id="saveEventFees" class="text-sm px-3 py-2 rounded bg-brand text-white hover:bg-brand/90 transition-all">Save local changes</button>
      </div>
    </section>

    <section class="card rounded-lg bg-white dark:bg-gray-800 p-4 shadow" data-role="Manager">
      <h2 class="text-xl font-semibold mb-3">Sponsor tracking</h2>
      <div id="sponsorTrack" class="grid sm:grid-cols-2 gap-3"></div>
    </section>

    <section class="card rounded-lg bg-white dark:bg-gray-800 p-4 shadow" data-role="Manager">
      <h2 class="text-xl font-semibold mb-3">Local data log</h2>
      <div class="text-sm space-y-2">
        <div>Clicks: <code id="logClicks"></code></div>
        <div>Sponsors (local overrides): <code id="logSponsorsLocal"></code></div>
        <div>Enrollments: <code id="logEnrollments"></code></div>
      </div>
      <div class="mt-3 flex gap-2">
        <button id="clearLocal" class="text-sm px-3 py-2 rounded border hover:bg-gray-100 dark:hover:bg-gray-800 transition-all">Clear localStorage</button>
        <button id="refreshData" class="text-sm px-3 py-2 rounded bg-accent text-white hover:bg-accent/80 transition-all">Refresh</button>
      </div>
    </section>
  </main>

  <script src="scripts/firebase.js"></script>
  <script src="scripts/sheets.js"></script>
  <script src="scripts/ui.js"></script>
  <script>
    (async function init() {
      window.SS.session = FirebaseAuth.getSession();
      UI.renderSession();
      UI.roleGate();

      document.getElementById("signBtn").addEventListener("click", async () => {
        await FirebaseAuth.signIn();
        UI.renderSession(); UI.roleGate();
      });
      document.getElementById("signOutBtn").addEventListener("click", async () => {
        await FirebaseAuth.signOut();
        UI.renderSession(); UI.roleGate();
      });

      await UI.loadUsersRoleMap();
      const events = await Sheets.get("events");
      const sponsors = await Sheets.get("sponsors");
      window.SS.events = events;
      window.SS.sponsors = sponsors;

      // Fee Editor (Founder)
      const editor = document.getElementById("eventFeeEditor");
      const localFees = JSON.parse(localStorage.getItem("SS_EVENT_FEES") || "{}");
      editor.innerHTML = events.map((ev, i) => `
        <div class="rounded border p-3">
          <div class="text-sm font-medium">${ev.title}</div>
          <input type="text" class="mt-2 w-full rounded border p-2" value="${localFees[ev.title] || ev.fee}" data-title="${ev.title}" />
        </div>
      `).join("");
      document.getElementById("saveEventFees").addEventListener("click", () => {
        const inputs = Array.from(editor.querySelectorAll("input"));
        const obj = {};
        inputs.forEach(inp => { obj[inp.dataset.title] = inp.value });
        localStorage.setItem("SS_EVENT_FEES", JSON.stringify(obj));
        alert("Local event fees saved.");
      });

      // Sponsor tracking (Manager)
      const track = document.getElementById("sponsorTrack");
      const clicks = JSON.parse(localStorage.getItem("SS_CLICKS") || "{}");
      track.innerHTML = sponsors.map(sp => `
        <div class="rounded border p-3">
          <div class="flex items-center gap-3">
            <img src="${sp.logo}" alt="${sp.name}" class="h-10 w-10 rounded" />
            <div>
              <div class="text-sm font-medium">${sp.name}</div>
              <div class="text-xs text-gray-500">Clicks: ${clicks[sp.id] || 0}</div>
            </div>
          </div>
          <div class="mt-2">
            <label class="text-xs">Metrics (JSON)</label>
            <textarea class="mt-1 w-full rounded border p-2 text-xs" rows="3" data-id="${sp.id}">${sp.metrics_json || "{}"}</textarea>
          </div>
          <button class="mt-2 text-xs px-2 py-1 rounded bg-brand text-white hover:bg-brand/90 transition-all" data-save="${sp.id}">Save locally</button>
        </div>
      `).join("");

      track.querySelectorAll("button[data-save]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-save");
          const ta = track.querySelector(`textarea[data-id="${id}"]`);
          const raw = localStorage.getItem("SS_METRICS") || "{}";
          const obj = JSON.parse(raw);
          obj[id] = ta.value;
          localStorage.setItem("SS_METRICS", JSON.stringify(obj));
          alert("Metrics saved locally.");
        });
      });

      // Local data log
      const refreshLog = () => {
        document.getElementById("logClicks").textContent = localStorage.getItem("SS_CLICKS") || "{}";
        document.getElementById("logSponsorsLocal").textContent = localStorage.getItem("SS_SPONSORS_LOCAL") || "[]";
        document.getElementById("logEnrollments").textContent = localStorage.getItem("SS_ENROLLMENTS") || "[]";
      };
      refreshLog();

      document.getElementById("clearLocal").addEventListener("click", () => {
        ["SS_CLICKS","SS_SPONSORS_LOCAL","SS_ENROLLMENTS","SS_EVENT_FEES","SS_METRICS"].forEach(k => localStorage.removeItem(k));
        refreshLog();
        alert("localStorage cleared for overrides.");
      });

      document.getElementById("refreshData").addEventListener("click", refreshLog);
    })();
  </script>
</body>
</html>
